{% extends "admin_base.html" %}

{% load static %}

{% block akun_content %}
<title>Monitoring</title>
<div class="flex flex-row mt-4">
            <div>
                <a href="{% url 'adminhome' %}" class="focus:outline-none text-[#141E61] bg-white hover:bg-[#141E61] hover:text-white focus:ring-2 font-medium rounded-2xl md:text-md text-sm md:px-8 px-2 py-2 shadow-md me-2 mb-2 transition-all ease-in duration-300">Current Reservation</a>
            </div>
            <div>
                <a href="" class="focus:outline-none text-white bg-[#141E61] focus:ring-2 font-medium rounded-2xl md:text-md text-sm md:px-8 px-2 py-2 shadow-md me-2 mb-2 transition-all ease-in duration-300">Park Monitoring</a>
            </div>
            <div>
                <a href="{% url 'adminreservation' %}" class="focus:outline-none text-[#141E61] bg-white hover:bg-[#141E61] hover:text-white focus:ring-2 font-medium rounded-2xl md:text-md text-sm md:px-8 px-2 py-2 shadow-md me-2 mb-2 transition-all ease-in duration-300">All Reservations</a>
            </div>
        </div>

        <div class="mt-4 bg-white rounded-2xl animate-fade-up">

              <!-- Park spot 1 -->
            <div class="md:px-12 px-8 pt-8 md:pt-12 flex justify-center">
              <h2 class="text-2xl md:text-4xl font-semibold tracking-wide text-[#141E61] fade-up border-b-2 border-gray-500 pb-1">
                Parking Spot
              </h2>
            </div>

            <div class="flex justify-center pb-4">
                <div class="mx-2 my-4 border px-4 border-4 border-[#141E61] rounded-lg shadow-[0_5px_5px_rgba(0,0,0,0.2)]">

                  <!-- selal -->
                   <div class="grid justify-items-end mx-4 mt-2">
                    <label class="gap-2 mb-4 border border-gray-600 cursor-pointer px-2 py-1 rounded-xl ">
                      <input type="checkbox" id="selectAll" class="w-4 h-4 text-purple-600 bg-gray-300 border-gray-300 rounded-sm focus:ring-purple-500 dark:focus:ring-purple-600">
                      <span class="text-gray-700 font-medium">Select All</span>
                    </label>
                    </div>

                <ul class=" grid grid-cols-4 md:gap-8 gap-2">

                        <!-- Slot 1 -->
                    <li>
                      <label for="slot1" class="flex justify-center text-sm font-semibold text-[#141E61]">Slot 1</label>
                      <div class="flex justify-center py-2">
                        <input type="checkbox" id="box1" class="hidden peer box-checkbox">
                        <label id="slot1-box" for="box1" class="w-[220px] flex items-center justify-center p-5 text-white bg-[#018214] border-2 border-gray-200 rounded-2xl cursor-pointer peer-checked:border-blue-600 peer-checked:ring-2 peer-checked:ring-blue-200 peer-checked:bg-opacity-80 transition-all duration-200 transition duration-300 ease-in-out transform hover:scale-[1.03] hover:brightness-75">
                          <img src="{% static 'main/car1.png' %}" class="w-20 md:w-28" alt="">
                        </label>
                      </div>
                      <div class="flex justify-center">
                        <p id="slot1-label" class="text-md text-[#018214] font-semibold">Available</p>
                        </div>
                        <div class="flex justify-center mt-2">
                        <button id="buzzer-btn-slot1"
                                onclick="turnOffBuzzer('1')"
                                class="hidden bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-1 rounded-lg">
                          Matikan Buzzer
                        </button>
                      </div>
                    </li>

                        <!-- Slot 2 -->
                    <li>
                      <label for="slot2" class="flex justify-center text-sm font-semibold text-[#141E61]">Slot 2</label>
                      <div class="flex justify-center py-2">
                        <input type="checkbox" id="box2" class="hidden peer box-checkbox">
                      <label id="slot2-box" for="box2" class="w-[220px] flex items-center justify-center p-5 text-white bg-[#018214] border-2 border-gray-200 rounded-2xl cursor-pointer peer-checked:border-blue-600 peer-checked:ring-2 peer-checked:ring-blue-200 peer-checked:bg-opacity-80 transition-all duration-200 transition duration-300 ease-in-out transform hover:scale-[1.03] hover:brightness-75">
                        <img src="{% static 'main/car2.png' %}" class="w-20 md:w-28" alt="">
                      </label>
                      </div>
                      <div class="flex justify-center">
                      <p id="slot2-label" class="text-md text-[#018214] font-semibold">Available</p>
                      </div>
                      <div class="flex justify-center mt-2">
                        <button id="buzzer-btn-slot2"
                                onclick="turnOffBuzzer('2')"
                                class="hidden bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-1 rounded-lg">
                          Matikan Buzzer
                        </button>
                      </div>
                    </li>


                    <!-- Slot 3 -->
                  <li>
                    <label for="slot3" class="flex justify-center text-sm font-semibold text-[#141E61]">Slot 3</label>
                    <div class="flex justify-center py-2">
                      <input type="checkbox" id="box3" class="hidden peer box-checkbox">
                    <label id="slot3-box" for="box3" class="w-[220px] flex items-center justify-center p-5 text-white bg-[#018214] border-2 border-gray-200 rounded-2xl cursor-pointer peer-checked:border-blue-600 peer-checked:ring-2 peer-checked:ring-blue-200 peer-checked:bg-opacity-80 transition-all duration-200 transition duration-300 ease-in-out transform hover:scale-[1.03] hover:brightness-75">
                      <img src="{% static 'main/car3.png' %}" class="w-20 md:w-28" alt="">
                    </label>
                    </div>
                    <div class="flex justify-center">
                    <p id="slot3-label" class="text-md text-[#018214] font-semibold">Available</p>
                    </div>
                    <div class="flex justify-center mt-2">
                      <button id="buzzer-btn-slot3"
                              onclick="turnOffBuzzer('3')"
                              class="hidden bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-1 rounded-lg">
                        Matikan Buzzer
                      </button>
                    </div>
                  </li>

                    <!-- Slot 4 -->
                  <li>
                    <label for="slot4" class="flex justify-center text-sm font-semibold text-[#141E61]">Slot 4</label>
                    <div class="flex justify-center py-2">
                      <input type="checkbox" id="box4" class="hidden peer box-checkbox">
                    <label id="slot4-box" for="box4" class="w-[220px] flex items-center justify-center p-5 text-white bg-[#018214] border-2 border-gray-200 rounded-2xl cursor-pointer peer-checked:border-blue-600 peer-checked:ring-2 peer-checked:ring-blue-200 peer-checked:bg-opacity-80 transition-all duration-200 transition duration-300 ease-in-out transform hover:scale-[1.03] hover:brightness-75">
                      <img src="{% static 'main/car4.png' %}" class="w-20 md:w-28" alt="">
                    </label>
                    </div>
                    <div class="flex justify-center">
                    <p id="slot4-label" class="text-md text-[#018214] font-semibold">Available</p>
                    </div>
                    <div class="flex justify-center mt-2">
                      <button id="buzzer-btn-slot4"
                              onclick="turnOffBuzzer('4')"
                              class="hidden bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-1 rounded-lg">
                        Matikan Buzzer
                      </button>
                    </div>
                  </li>
              </ul>

              <div class="flex justify-end mt-6">
                <div class=" gap-4 mb-4">
                  <label for="colorSelect" class="text-gray-700 text-sm font-medium">Reason:</label>
                  <select id="colorSelect" class="px-4 md:pr-12 pr-8 md:text-md text-sm md:py-2 py-1.5 border rounded">
                    <option value="bg-[#018214]">Available</option>
                    <option value="bg-gray-300">Disabled</option>
                  </select>
                </div>
                <div class="ml-6">
                    <button onclick="updateSelectedColors()" class="bg-[#141E61] md:text-md text-sm text-white md:px-20 px-12 md:py-2 py-1.5 rounded hover:bg-blue-700 hover:focus:ring-blue-300">Update</button>
                </div>

              </div>
            </div>
            </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {

  /* ───────────────── COLOR MAP ───────────────── */
  const COLORS = {
    occupied : { bg:'#8a1616', text:'#8a1616', label:'Occupied'  },
    reserved : { bg:'#afd106', text:'#afd106', label:'Reserved'  },
    available: { bg:'#018214', text:'#018214', label:'Available' },
    disabled : { bg:'#A0A0A0', text:'#A0A0A0', label:'Disabled'  },
  };

  /* ───────────────── HELPERS ───────────────── */
  const todayISO = () => {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());  // konversi ke waktu lokal
    return now.toISOString().slice(0, 10);
  };
  function getCookie(name) { // ambil CSRF utk fetch POST
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  /* ───────────────── RENDER SLOT ───────────────── */
  function renderSlot(n, status, buzzerActive = false){
    const box   = document.getElementById(`slot${n}-box`);
    const label = document.getElementById(`slot${n}-label`);
    const btn   = document.getElementById(`buzzer-btn-slot${n}`);
    if(!box || !label) return;

    box.style.backgroundColor = COLORS[status].bg;
    label.style.color         = COLORS[status].text;
    label.textContent         = COLORS[status].label;

    if (btn) {
      if (status === 'occupied' && buzzerActive) {
        btn.classList.remove("hidden");
        btn.disabled = false;
        btn.textContent = "Matikan Buzzer";
        btn.classList.remove("bg-gray-400");
        btn.classList.add("bg-red-600");
      } else {
        btn.classList.add("hidden");
      }
    }
  }

  /* ───────────────── POLL STATUS ───────────────── */
  function poll(){
    fetch(`/api/spots-dynamic-status/?date=${todayISO()}`)
      .then(r => r.json())
      .then(data => data.forEach(s => {
        const slotNum = s.spot_number;  // pakai langsung tanpa replace
        renderSlot(slotNum, s.status, s.buzzer_active);
      }))
      .catch(err => {
        console.error("Polling error:", err);
      });
  }

  // Panggil saat halaman pertama kali dibuka
  poll();
  const pollInterval = setInterval(() => {
    if (document.visibilityState === 'visible') poll();
  }, 3000);  // polling setiap 3 detik

  /* ───────────────── UPDATE SELECTED SPOTS ───────────────── */
  window.updateSelectedColors = function () {
    const disableOption = document.getElementById('colorSelect').value === 'bg-gray-300';
    const selectedSlots = [...document.querySelectorAll('.box-checkbox')]
                            .filter(cb => cb.checked)
                            .map(cb => cb.id.replace('box',''));   // ['1','2',...]

    if (selectedSlots.length === 0) return;

    fetch('/api/toggle-spot-disable/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken' : getCookie('csrftoken'),
      },
      body: JSON.stringify({ spot_numbers: selectedSlots, disable: disableOption })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success){
        poll();  // refresh tampilan
        document.querySelectorAll('.box-checkbox').forEach(cb => cb.checked = false);
      } else {
        alert('Gagal mengupdate status: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error(err);
      alert('Request gagal. Silakan cek koneksi.');
    });
  };

  /* ───────────────── SELECT ALL ───────────────── */
  document.getElementById('selectAll').addEventListener('change', function(){
    document.querySelectorAll('.box-checkbox').forEach(cb => cb.checked = this.checked);
  });

  /* ───────────────── BUZZER CONTROL ───────────────── */
  window.turnOffBuzzer = function(slotNumber) {
    fetch("/api/admin-turn-off-buzzer/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ slot_number: slotNumber })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        const btn = document.getElementById(`buzzer-btn-slot${slotNumber}`);
        btn.innerText = "Dimatikan";
        btn.disabled = true;
        btn.classList.remove("bg-red-600");
        btn.classList.add("bg-gray-400");
        alert(`✅ Buzzer slot ${slotNumber} berhasil dimatikan.`);
      } else {
        alert("❌ Gagal mematikan buzzer: " + data.error);
      }
    })
    .catch(err => {
      console.error(err);
      alert("❌ Terjadi kesalahan saat mematikan buzzer.");
    });
  };

});
</script>

        </div>
{% endblock %}
