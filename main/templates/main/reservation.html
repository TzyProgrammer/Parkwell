{% extends "headfoot.html" %}

{% block title %}Home Page{% endblock %}

{% load static %}

{% block content %}

<div class="md:pl-16 py-1 pt-12 md:text-left text-center">
            <span class="text-[50px] text-[#141E61] md:text-[clamp(34px,4vw,50px)]">
                Reserve Your Spot
            </span>
</div>

<div class="flex pb-4 md:pb-8 flex-col md:flex-row mb-12 ">

    <!-- Kiri -->
    <div class=" flex-col flex md:w-2/5 md:order-1 order-2">
        


        <div class="md:px-12 px-8 md:my-20 my-8 md:mx-12 flex flex-col">
        <form action="" method="POST">
            {% csrf_token %}

            <!-- pslot -->
            <div>   
                <span class="text-gray-500 text-lg">Parking Slot :</span>
                <select id="slot" name="slot" class=" bg-white border border-gray-400 text-[#0F044C] text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
                    <option selected disabled hidden >Choose Slot</option>
                    <option value="1">Slot 1</option>
                    <option value="2">Slot 2</option>
                    <option value="3">Slot 3</option>
                    <option value="4">Slot 4</option>
                </select>
            </div>

            <!-- date -->
            <div class="my-6">
                <span class="text-gray-500 text-lg">Date :</span>
                <input readonly type="text" name="date" id="default-date" class="bg-gray-100 border border-gray-400 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 " required>

            </div>

            <!-- booking time -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <span class="text-gray-500 text-lg">From :</span>
                        <select id="start" name="start_time" class=" bg-white border border-gray-400 text-[#0F044C] text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
                            <option selected disabled hidden ></option>
                            <option value="07:00">07:00</option>
                            <option value="07:30">07:30</option>
                            <option value="08:00">08:00</option>
                            <option value="08:30">08:30</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="12:00">12:00</option>
                            <option value="12:30">12:30</option>
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                            <option value="17:30">17:30</option>
                            <option value="18:00">18:00</option>
                            <option value="18:30">18:30</option>
                            <option value="19:00">19:00</option>
                            <option value="19:30">19:30</option>
                            <option value="20:00">20:00</option>
                            <option value="20:30">20:30</option>
                            <option value="21:00">21:00</option>
                            <option value="21:30">21:30</option>
                            <option value="22:00">22:00</option>
                            <option value="22:30">22:30</option>
                            <option value="23:00">23:00</option>
                        </select>
                </div>
                <div>
                    <span class="text-gray-500 text-lg">Until :</span>
                        <select id="end" name="end_time" class=" bg-white border border-gray-400 text-[#0F044C] text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
                            <option selected disabled hidden ></option>
                            <option value="07:00">07:00</option>
                            <option value="07:30">07:30</option>
                            <option value="08:00">08:00</option>
                            <option value="08:30">08:30</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="12:00">12:00</option>
                            <option value="12:30">12:30</option>
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                            <option value="17:30">17:30</option>
                            <option value="18:00">18:00</option>
                            <option value="18:30">18:30</option>
                            <option value="19:00">19:00</option>
                            <option value="19:30">19:30</option>
                            <option value="20:00">20:00</option>
                            <option value="20:30">20:30</option>
                            <option value="21:00">21:00</option>
                            <option value="21:30">21:30</option>
                            <option value="22:00">22:00</option>
                            <option value="22:30">22:30</option>
                            <option value="23:00">23:00</option>
                        </select>
                </div>
            </div>

            <!-- mengdisable jam yang sudah direservasi -->
             <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const dateInput = document.getElementById('default-datepicker');
                    const spotInput = document.getElementById('slot');
                    const startSelect = document.getElementById('start');
                    const endSelect = document.getElementById('end');

                    function formatDateToISO(dateString) {
                        const [month, day, year] = dateString.split('/');
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }

                    function updateTimeOptions(reservedTimes) {
                        // Re-enable all options
                        for (let opt of startSelect.options) {
                            opt.disabled = false;
                            opt.classList.remove('opacity-50');
                        }
                        for (let opt of endSelect.options) {
                            opt.disabled = false;
                            opt.classList.remove('opacity-50');
                        }

                        // Disable reserved
                        reservedTimes.forEach(time => {
                            const startOpt = [...startSelect.options].find(opt => opt.value === time);
                            const endOpt = [...endSelect.options].find(opt => opt.value === time);
                            if (startOpt) {
                                startOpt.disabled = true;
                                startOpt.classList.add('opacity-50');
                            }
                            if (endOpt) {
                                endOpt.disabled = true;
                                endOpt.classList.add('opacity-50');
                            }
                        });
                    }

                    function fetchReservedTimesAndDisable() {
                        const date = dateInput.value;
                        const spot = spotInput.value;

                        if (!date || !spot) return;

                        const formattedDate = formatDateToISO(date);
                        if (!formattedDate) return;

                        fetch(`/api/reserved-intervals/?date=${formattedDate}&spot=${spot}`)
                            .then(res => res.json())
                            .then(data => updateTimeOptions(data.reserved_times))
                            .catch(err => console.error(err));
                    }

                    // Initial load
                    fetchReservedTimesAndDisable();

                    // Trigger on change
                    dateInput.addEventListener('change', fetchReservedTimesAndDisable);
                    spotInput.addEventListener('change', fetchReservedTimesAndDisable);
                });

                // supaya end time cuma bisa pilih yang setelah start time
                document.getElementById('start').addEventListener('change', function () {
                    const selectedStart = this.value;
                    const endSelect = document.getElementById('end');

                    if (!selectedStart || !endSelect) return;

                    const selectedHour = parseInt(selectedStart.split(':')[0], 10);
                    const selectedMin = parseInt(selectedStart.split(':')[1], 10);

                    Array.from(endSelect.options).forEach(opt => {
                        const [optHour, optMin] = opt.value.split(':').map(Number);

                        if (
                            optHour < selectedHour || 
                            (optHour === selectedHour && optMin <= selectedMin)
                        ) {
                            opt.disabled = true;
                            opt.classList.add('opacity-50');
                        } else {
                            opt.disabled = false;
                            opt.classList.remove('opacity-50');
                        }
                    });
                });
             </script>
        
            <div class="mt-12">
                <button class="shadow-[0_5px_5px_rgba(0,0,0,0.2)] w-full block focus:outline-none text-white bg-[#141E61] hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-[50px] text-lg px-5 py-2.5 me-2 mb-2 text-center" type="submit">Reserve</button>
            </div>

        </form>
        </div>
        

    </div>



    <!-- Kanan -->
    <div class="flex-col flex md:w-3/5 md:order-2 order-1">
        
        <div class="mx-4 px-2 mt-8 md:mt-0 md:mx-12 flex flex-col">

            <!-- date -->
            <div >   

                <div class="text-[#0F044C] font-medium rounded-lg text-sm text-center inline-flex items-center ">
                <!--
                <input readonly datepicker datepicker-format="mm/dd/yyyy" data-date-min="{{ today }}" data-date-max="{{ two_weeks }}" id="default-datepicker" name="datepicker" type="text" class=" bg-white text-sm rounded-lg placeholder-[#141E61] border border-2 border-[#141E61] hover:bg-[#141E61] hover:placeholder-white cursor-pointer focus:ring-blue-500 focus:border-blue-500 px-4 py-1.5  w-auto"  size="8" placeholder="Select date" >                                                                 
                -->
                <input
                    id="default-datepicker"
                    name="date"
                    type="text"
                    data-datepicker
                    data-date-format="mm/dd/yyyy"
                    min="{{ today }}"
                    max="{{ two_weeks }}"
                    class="bg-white text-sm rounded-lg border border-2 border-[#141E61] px-4 py-1.5 placeholder-[#141E61] hover:bg-[#141E61] hover:placeholder-white cursor-pointer focus:ring-blue-500 focus:border-blue-500 w-auto" size="8"
                    placeholder="Select date"
                    readonly
                    />
                </div>
                <!-- script ini harus disini, tak bisa di app.js -->
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const input = document.getElementById('default-datepicker');

                        if (window.Datepicker && input) {
                            const today = new Date("{{ today|escapejs }}");
                            const maxDate = new Date("{{ two_weeks|escapejs }}");

                            new Datepicker(input, {
                                format: 'mm/dd/yyyy',
                                minDate: today,
                                maxDate: maxDate,
                                autohide: true,
                            });

                            console.log("Datepicker initialized with:", today, maxDate);
                        } else {
                            console.error('Datepicker or input not found.');
                        }
                    });
                </script>

            </div>

            <!-- park -->
            <div class=" my-4 border border-4 border-[#141E61] rounded-lg shadow-[0_5px_5px_rgba(0,0,0,0.2)]">

                    <div class="p-4 justify-center flex text-3xl bg-[#141E61] font-medium text-white">
                        Where would you like to park?
                    </div>

                <div class="grid grid-cols-4">
                        {% for i in "1234" %}
                        <!-- ==================== SLOT {{ i }} ==================== -->
                        <div>
                            <div id="slot-{{ i }}-box" class="py-8 justify-center items-center flex bg-[#018214] rounded-2xl mx-3 mt-3">
                                <button id="slot-{{ i }}-btn" onclick="setSlotDirectly('{{ i }}')">
                                    <img src="{% static 'main/car'|add:i|add:'.png' %}" alt="" class="block w-20 md:w-28 h-auto transition duration-300 ease-in-out transform hover:scale-110 hover:brightness-75">
                                </button>
                            </div>
                            <div class="items-center flex justify-center py-2">
                                <p id="slot-{{ i }}-label" class="text-md text-[#018214] font-semibold">Available</p>
                            </div>
                    
                            <!-- Modal OCCUPIED Slot {{ i }} -->
                            <div id="popup-modal{{ i }}" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                                <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md relative">
                                    <button class="absolute top-2 right-2 text-gray-500 hover:text-black" data-modal-hide="popup-modal{{ i }}">&times;</button>
                                    <svg class="mx-auto mb-4 text-[#8a1616] w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                    <h3 class="mb-5 text-center text-gray-500 text-lg">This parking slot is currently <span class="font-semibold text-[#8a1616]">Occupied</span>. However, you can still make a reservation.</h3>
                                    <div class="flex justify-center gap-2">
                                        <button data-modal-hide="popup-modal{{ i }}" class="bg-[#8a1616] text-white px-4 py-2 rounded hover:bg-[#731212]">Reserve Anyway</button>
                                        <button data-modal-hide="popup-modal{{ i }}" class="bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300">No, cancel</button>
                                    </div>
                                </div>
                            </div>
                    
                            <!-- Modal RESERVED Slot {{ i }} -->
                            <div id="popup-modal{{ i }}-reserved" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                                <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md relative">
                                    <button class="absolute top-2 right-2 text-gray-500 hover:text-black" data-modal-hide="popup-modal{{ i }}-reserved">&times;</button>
                                    <svg class="mx-auto mb-4 text-[#afd106] w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                    <h3 class="mb-5 text-center text-gray-500 text-lg">This parking slot has already been <span class="font-semibold text-[#afd106]">Reserved</span>. However, you can still reserve it for other available time slots.</h3>
                                    <div class="flex justify-center gap-2">
                                        <button data-modal-hide="popup-modal{{ i }}-reserved" class="bg-[#afd106] text-white px-4 py-2 rounded hover:bg-[#91ad05]">Reserve Anyway</button>
                                        <button data-modal-hide="popup-modal{{ i }}-reserved" class="bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300">No, cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- ==================== JS ==================== -->
                    <script>
                    let selectedSlotValue;
                    const selectElement = document.getElementById('slot');
                    
                    function setSlotDirectly(value) {
                        if (selectElement) selectElement.value = value;
                    }
                    
                    // ==================== Modal JS ==================== //
                    document.addEventListener('DOMContentLoaded', () => {
                        // close on button
                        document.querySelectorAll('[data-modal-hide]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const modalId = btn.getAttribute('data-modal-hide');
                                document.getElementById(modalId).classList.add('hidden');
                            });
                        });
                        // close on backdrop
                        document.querySelectorAll('.fixed').forEach(modal => {
                            modal.addEventListener('click', e => {
                                if (e.target === modal) modal.classList.add('hidden');
                            })
                        })
                    });
                    
                    // ==================== Fetch Status AJAX ==================== //
                    function updateSlotDisplay(slotNumber, status) {
                        const box = document.getElementById(`slot-${slotNumber}-box`);
                        const label = document.getElementById(`slot-${slotNumber}-label`);
                        const btn = document.getElementById(`slot-${slotNumber}-btn`);
                    
                        box.className = "py-8 justify-center items-center flex rounded-2xl mx-3 mt-3";
                        label.className = "text-md font-semibold";
                    
                        if (status === "occupied") {
                            box.classList.add('bg-[#8a1616]');
                            label.classList.add('text-[#8a1616]');
                            label.innerText = "Occupied";
                            btn.onclick = () => document.getElementById(`popup-modal${slotNumber}`).classList.remove('hidden');
                        } else if (status === "reserved") {
                            box.classList.add('bg-[#afd106]');
                            label.classList.add('text-[#afd106]');
                            label.innerText = "Reserved";
                            btn.onclick = () => document.getElementById(`popup-modal${slotNumber}-reserved`).classList.remove('hidden');
                        } else {
                            box.classList.add('bg-[#018214]');
                            label.classList.add('text-[#018214]');
                            label.innerText = "Available";
                            btn.onclick = () => setSlotDirectly(slotNumber);
                        }
                    }

                    function formatDateToISO(dateStr) {
                        const [month, day, year] = dateStr.split('/');
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    
                    // Fetch every 3s
                    setInterval(() => {
                        const dateInput = document.getElementById('default-datepicker');
                        const selectedDate = dateInput ? dateInput.value : '';

                        if (!selectedDate) return; 

                        const formattedDate = formatDateToISO(selectedDate)

                        fetch(`/api/spots-dynamic-status/?date=${formattedDate}`)
                            .then(res => res.json())
                            .then(data => {
                                data.forEach(spot => updateSlotDisplay(spot.spot_number, spot.status));
                            })
                            .catch(err => console.error(err));
                    }, 3000);

                    /* testing
                    document.addEventListener('DOMContentLoaded', () => {
                        const dateInput = document.getElementById('default-datepicker');

                        function fetchSlotStatusByDate(selectedDate) {
                            if (!selectedDate) return;

                            const formattedDate = formatDateToISO(selectedDate);

                            fetch(`/api/spots-dynamic-status/?date=${formattedDate}`)
                                .then(res => res.json())
                                .then(data => {
                                    data.forEach(spot => updateSlotDisplay(spot.spot_number, spot.status));
                                })
                                .catch(err => console.error(err));
                        }

                        if (dateInput) {

                            fetchSlotStatusByDate(dateInput.value);

                            dateInput.addEventListener('change', () => {
                                fetchSlotStatusByDate(dateInput.value)
                            });

                            setInterval(() => {
                                fetchSlotStatusByDate(dateInput.value);
                            }, 3000)
                        }
                    });
                    */
                    
                    </script>
                
            </div>

            </div>
        </div>
        

    </div>

</div>


{% endblock %}